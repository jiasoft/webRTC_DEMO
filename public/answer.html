<!--
> qiutujia     - 
> Documentation - answer
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <title>B端（answer）</title>
    <link rel="icon" type="image/svg+xml" href="/logo.svg" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="qiutujia">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .message {
            margin: 5px;
            color: #666
        }
    </style>
</head>

<body>
    <div id="videoBox"></div>
    <script>
        //1.初始化RTCPeerConnection,设置STUN server
        //  注意 stun:www.dudult.com:3478是我搭建的服务器
        //  stun:stun.l.google.com:19302是谷歌提供
        //  先用谷歌的吧，我搭建的服务器的还在调试中
        const serverConfig = { "iceServers": [{ "urls": ["stun:www.dudult.com:3478"] }], "iceTransportPolicy": "all" }
        const serverConfigGL = { "iceServers": [{ "urls": ["stun:stun.l.google.com:19302"] }], "iceTransportPolicy": "all" }
        const RTCPeer = new RTCPeerConnection(serverConfigGL);
        //createDataChannel发送文字相关的
        const dataChannel = RTCPeer.createDataChannel('')
        dataChannel.onmessage = function (event) {
            console.log(event)
        }
        RTCPeer.ondatachannel = function (event) {
            console.log('ondatachannel', event);
        }
        RTCPeer.oniceconnectionstatechange = (ev) => {
            console.log('RTCPeerConnection ICE state change', RTCPeer.iceConnectionState, ev)
        }

        RTCPeer.onicecandidateerror = (ev) => {
            console.error('ice candidate error', ev)
        }
        //7.连接成功,通过 RTCPeer.onaddstream 获取到对方的视频 显示
        RTCPeer.onaddstream = function (obj) {

            const video = document.createElement("video");
            document.getElementById('videoBox').appendChild(video);
            video.controls = true;
            video.muted = false;
            video.autoplay = true;
            video.srcObject = obj.stream;
            video.play();
            video.onloadedmetadata = function (event) {
                video.play();
            };
        }

        //5.获取自已的candidate
        RTCPeer.onicecandidate = function (event) {

            if (!event.candidate)
                return;
            console.log("onicecandidate:", event.candidate.type, event.candidate);
            const message = document.createElement('div');
            message.innerHTML = `<div class="message">onicecandidate:<span style="color:red">${event.candidate.type}</span>,  ${JSON.stringify(event.candidate)} </div>`;
            document.body.appendChild(message);

            axios.post('/answer/candidate/send', event.candidate).then(function (response) {
                console.log(response);
            }).catch(function (error) {
                console.log(error);
            });
        }

        function endCall() {
            var videos = document.getElementsByTagName("video");
            for (var i = 0; i < videos.length; i++) {
                videos[i].pause();
            }
            RTCPeer.close();
        }
        //错误处理
        function catchError(event) { console.error(event); endCall() }

        //3. 接收offe的SDP
        function waitOffer() {
            (function waitLoop() { //循环等待
                axios.get('/offer/sdp/get').then(function (response) {
                    const offer = response.data
                    if (!offer) {
                        setTimeout(waitLoop, 500);
                        return;
                    }
                    RTCPeer.setRemoteDescription(new RTCSessionDescription(offer), function () {
                        //4. 创建answer
                        RTCPeer.createAnswer(function (answer) {
                            RTCPeer.setLocalDescription(new RTCSessionDescription(answer), function () {
                                //发送SDP
                                axios.post('/answer/sdp/send', answer).then(function (response) {
                                    console.log(response);
                                }).catch(function (error) {
                                    console.error(error);
                                });

                                //6. 收集A端的candidate
                                axios.get('/offer/candidate/get').then(function (response) {
                                    let candidateList = response.data;
                                    candidateList.forEach(candidate => {
                                        RTCPeer.addIceCandidate(new RTCIceCandidate({
                                            sdpMLineIndex: candidate.sdpMLineIndex,
                                            candidate: candidate.candidate
                                        }))

                                    })
                                })
                            }, catchError);
                        }, catchError);

                    }, catchError);
                });
            })();

        }

        //2. 打开自已的视频, 把视频的流放在RTCPeer里
        function getUserMedia(callback) {

            const hints = {
                audio: true,
                video: {
                    width: 300, height: 200
                }
            };
            //打开自已的视频
            navigator.mediaDevices.getUserMedia(hints).then(function (mediaStream) {
                const video = document.createElement('video');
                document.getElementById('videoBox').appendChild(video);

                video.srcObject = mediaStream;
                video.controls = true;
                video.muted = true;
                video.onloadedmetadata = function (event) {
                    video.play();
                };
                callback(mediaStream)
            })
        }


        getUserMedia(function (stream) {
            if (stream) {
                //把视频的流放在RTCPeer里
                stream.getTracks().forEach(function (track) {
                    RTCPeer.addTrack(track, stream);
                });
            }

            waitOffer();//接收offe的SDP
        })
    </script>

</body>

</html>